<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de bulto - Obrero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #0b1f3b;
      color: #f5f7ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .card {
      max-width: 420px;
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
    }
    .badge-estado {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
    }
    #debug {
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="card text-dark">
    <div class="card-body">
      <h5 class="card-title mb-1">Registro de bulto</h5>
      <p class="text-muted mb-3" style="font-size: 0.85rem;">
        Escanea el c√≥digo QR o pega el ID del bulto.
      </p>

      <div class="mb-3">
        <label for="idBulto" class="form-label">ID del bulto</label>
        <input type="text" id="idBulto" class="form-control form-control-sm" placeholder="Pega aqu√≠ el ID">
      </div>

      <button class="btn btn-primary btn-sm w-100 mb-2" onclick="buscarBulto()">
        Buscar bulto
      </button>

      <!-- Mensaje visible SIEMPRE, para depurar -->
      <p id="debug" class="text-danger"></p>

      <!-- Info del bulto, SIEMPRE visible (no la ocultamos) -->
      <hr>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-semibold" id="txtParte">Parte: ‚Äî</div>
          <div class="text-muted" id="txtCaja" style="font-size: 0.85rem;">Caja: ‚Äî</div>
          <div class="text-muted" id="txtPosicion" style="font-size: 0.8rem;">Bulto ‚Äî de ‚Äî</div>
        </div>
        <span id="badgeEstado" class="badge bg-secondary badge-estado">Sin buscar</span>
      </div>

      <div class="mb-3">
        <label for="piezas" class="form-label">Piezas en este bulto</label>
        <input type="number" id="piezas" class="form-control form-control-sm" min="0">
      </div>

      <div class="mb-3">
        <label for="operario" class="form-label">Tu nombre</label>
        <input type="text" id="operario" class="form-control form-control-sm" placeholder="Ej: Juan P.">
      </div>

      <button class="btn btn-success btn-sm w-100" id="btnGuardar" onclick="guardarPiezas()">
        Guardar registro
      </button>

      <p id="mensaje" class="mt-3 mb-0" style="font-size: 0.85rem;"></p>
    </div>
  </div>

  <script>
    console.log('Script de obrero cargado ‚úÖ');

    const API_URL = "https://script.google.com/macros/s/AKfycbznafe3znRaCXIxCxBvzvUt5WI7A7an1GdGnk7-VZwaOIXBjU7ZgsF-eZxfFu7PG-TXHA/exec";

    let ultimoBulto = null;

    async function buscarBulto() {
        const idBultoInput = document.getElementById('idBulto');
        const idBulto = idBultoInput.value.trim();
        const debug = document.getElementById('debug');
        const mensaje = document.getElementById('mensaje');

        debug.textContent = '';
        mensaje.textContent = '';

        if (!idBulto) {
            debug.textContent = '‚ö† Escribe o escanea un ID de bulto.';
            return;
        }

        debug.textContent = 'Buscando bulto...';

        try {
            const resp = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'getBulto',
                idBulto: idBulto
            })
            });

            const text = await resp.text();        // üëà leemos TEXTO crudo
            console.log('Respuesta cruda getBulto:', text);

            let data;
            try {
            data = JSON.parse(text);             // üëà intentamos convertir a JSON
            } catch (e) {
            debug.textContent = '‚ùå Respuesta no v√°lida del servidor: ' + text.slice(0, 120) + '...';
            return;
            }

            if (!data.ok) {
            debug.textContent = '‚ö† ' + (data.error || 'No se pudo obtener el bulto.');
            return;
            }

            const b = data.bulto;
            ultimoBulto = b;

            document.getElementById('txtParte').textContent = `Parte: ${b.numeroParte}`;
            document.getElementById('txtCaja').textContent = `Caja: ${b.idCaja}`;
            document.getElementById('txtPosicion').textContent = `Bulto ${b.correlativo} de ${b.totalBultos}`;

            const badge = document.getElementById('badgeEstado');
            const piezasInput = document.getElementById('piezas');
            const btnGuardar = document.getElementById('btnGuardar');

            piezasInput.value = b.piezasRegistradas || '';

            if (b.estado === 'registrado') {
            badge.textContent = 'Registrado';
            badge.className = 'badge bg-success badge-estado';
            piezasInput.disabled = true;
            btnGuardar.disabled = true;
            mensaje.textContent = '‚úÖ Este bulto ya fue registrado.';
            } else {
            badge.textContent = 'Pendiente';
            badge.className = 'badge bg-warning text-dark badge-estado';
            piezasInput.disabled = false;
            btnGuardar.disabled = false;
            mensaje.textContent = '';
            }

            debug.textContent = '‚úÖ Bulto encontrado.';

        } catch (err) {
            console.error(err);
            debug.textContent = '‚ùå Error de conexi√≥n con el servidor: ' + err;
        }
    }

    async function guardarPiezas() {
      const debug = document.getElementById('debug');
      const mensaje = document.getElementById('mensaje');

      debug.textContent = '';
      mensaje.textContent = '';

      if (!ultimoBulto) {
        debug.textContent = '‚ö† Primero busca un bulto.';
        return;
      }

      const piezasInput = document.getElementById('piezas');
      const operarioInput = document.getElementById('operario');

      const piezas = Number(piezasInput.value);
      const operario = operarioInput.value.trim();

      if (isNaN(piezas) || piezas < 0) {
        debug.textContent = '‚ö† Cantidad de piezas inv√°lida.';
        return;
      }

      if (!operario) {
        debug.textContent = '‚ö† Escribe tu nombre.';
        return;
      }

      debug.textContent = 'Guardando registro...';

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'registrarPiezas',
            idBulto: ultimoBulto.idBulto,
            piezas: piezas,
            operario: operario
          })
        });

        const data = await resp.json();
        console.log('Respuesta registrarPiezas:', data);

        if (data.ok) {
          mensaje.textContent = '‚úÖ Bulto registrado correctamente.';
          document.getElementById('badgeEstado').textContent = 'Registrado';
          document.getElementById('badgeEstado').className = 'badge bg-success badge-estado';
          piezasInput.disabled = true;
          document.getElementById('btnGuardar').disabled = true;
          debug.textContent = '';
        } else {
          debug.textContent = '‚ö† ' + (data.error || 'No se pudo guardar el registro.');
        }

      } catch (err) {
        console.error(err);
        debug.textContent = '‚ùå Error de conexi√≥n al guardar.';
      }
    }
  </script>
</body>
</html>
